name:  Per-Commit Test

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
        
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: false
        docker-images: true
        swap-storage: true

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install CPU-only versions to save space (PyTorch & TensorFlow)
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install tensorflow-cpu
        # Install other requirements, ignoring lines that would reinstall heavy GPU packages
        if [ -f requirements.txt ]; then 
          # Filter out torch and tensorflow from requirements.txt to prevent overwriting with GPU versions
          grep -vE "torch|tensorflow" requirements.txt > requirements_filtered.txt
          pip install -r requirements_filtered.txt
        fi
        
    - name: Test with pytest
      run: |
        pytest